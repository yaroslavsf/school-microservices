name: mvp-microservices-platform

networks:
  edge:
  internal:

volumes:
  traefik_letsencrypt:
  grafana_data:
  prometheus_data:
  loki_data:
  tempo_data:
  authentik_db_data:
  authentik_redis_data:
  py_db_data:
  js_db_data:
  rabbitmq_data:

services:
  # ----------------------------
  # Reverse Proxy
  # ----------------------------
  traefik:
    image: traefik:v3.6.2
    command:
      - --api.dashboard=true
      - --api.insecure=true

      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      - --entrypoints.web.address=:80
      # TLS можно включить позже; для MVP оставляем HTTP
      # - --entrypoints.websecure.address=:443

      # (опционально) Логи Traefik в stdout
      - --log.level=INFO
      - --accesslog=true
    ports:
      - "80:80"
      - "8080:8080" # Traefik dashboard (dev)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - edge
      - internal
    labels:
      - traefik.enable=true

      # ForwardAuth middleware (authentik outpost)
      - traefik.http.middlewares.authentik.forwardauth.address=http://authentik-proxy:9000/outpost.goauthentik.io/auth/traefik
      - traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true

      # Headers, которые authentik вернет и Traefik прокинет в сервисы
      - traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-email,X-authentik-groups,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version

  # ----------------------------
  # Python service (FastAPI)
  # ----------------------------
  py-service:
    build:
      context: ../py-service
      dockerfile: Dockerfile
    environment:
      - SERVICE_NAME=py-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=py-service
      - DATABASE_URL=postgresql+psycopg://py:py@py-db:5432/py_service
      - AMQP_URL=amqp://app:app@rabbitmq:5672/
    labels:
      - traefik.enable=true
      - traefik.http.routers.py.rule=Host(`py.localhost`)
      - traefik.http.routers.py.entrypoints=web
      - traefik.http.routers.py.middlewares=authentik@docker
      - traefik.http.services.py.loadbalancer.server.port=8000
    networks:
      - internal
    depends_on:
      - py-db
      - rabbitmq
      - otel-collector

  py-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=py
      - POSTGRES_PASSWORD=py
      - POSTGRES_DB=py_service
    volumes:
      - py_db_data:/var/lib/postgresql/data
    networks:
      - internal

  # ----------------------------
  # JS service (Fastify)
  # ----------------------------
  js-service:
    build:
      context: ../js-service
      dockerfile: Dockerfile
    environment:
      - SERVICE_NAME=js-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=js-service
      - DATABASE_URL=postgresql://js:js@js-db:5432/js_service
      - AMQP_URL=amqp://app:app@rabbitmq:5672/
    labels:
      - traefik.enable=true
      - traefik.http.routers.js.rule=Host(`js.localhost`)
      - traefik.http.routers.js.entrypoints=web
      - traefik.http.routers.js.middlewares=authentik@docker
      - traefik.http.services.js.loadbalancer.server.port=3000
    networks:
      - internal
    depends_on:
      - js-db
      - rabbitmq
      - otel-collector

  js-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=js
      - POSTGRES_PASSWORD=js
      - POSTGRES_DB=js_service
    volumes:
      - js_db_data:/var/lib/postgresql/data
    networks:
      - internal

  # ----------------------------
  # Grafana
  # ----------------------------
  grafana:
    image: grafana/grafana:11.1.0
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://grafana.localhost
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.grafana.rule=Host(`grafana.localhost`)
      - traefik.http.routers.grafana.entrypoints=web
      - traefik.http.routers.grafana.middlewares=authentik@docker
      - traefik.http.services.grafana.loadbalancer.server.port=3000
    networks:
      - internal
    depends_on:
      - prometheus
      - loki
      - tempo

  # ----------------------------
  # Loki (logs storage)
  # ----------------------------
  loki:
    image: grafana/loki:3.1.1
    command: -config.file=/etc/loki/config.yml
    volumes:
      - loki_data:/loki
      - ./loki/config.yml:/etc/loki/config.yml:ro
    networks:
      - internal

  # Promtail (log collector)
  promtail:
    image: grafana/promtail:3.1.1
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
    networks:
      - internal
    depends_on:
      - loki

  # ----------------------------
  # Prometheus (metrics)
  # ----------------------------
  prometheus:
    image: prom/prometheus:v2.54.1
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
    volumes:
      - prometheus_data:/prometheus
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - internal

  # ----------------------------
  # Tempo (traces storage)
  # ----------------------------
  tempo:
    image: grafana/tempo:2.6.1
    command: [ "-config.file=/etc/tempo/tempo.yml" ]
    volumes:
      - tempo_data:/var/tempo
      - ./tempo/tempo.yml:/etc/tempo/tempo.yml:ro
    networks:
      - internal

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.109.0
    command: [ "--config=/etc/otel/config.yml" ]
    volumes:
      - ./otel/config.yml:/etc/otel/config.yml:ro
    networks:
      - internal
    depends_on:
      - tempo

  # ----------------------------
  # Authentik (OIDC / SSO)
  # ----------------------------
  authentik-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=authentik
      - POSTGRES_PASSWORD=authentik
      - POSTGRES_DB=authentik
    volumes:
      - authentik_db_data:/var/lib/postgresql/data
    networks:
      - internal

  authentik-redis:
    image: redis:7-alpine
    command: [ "redis-server", "--save", "60", "1", "--loglevel", "warning" ]
    volumes:
      - authentik_redis_data:/data
    networks:
      - internal

  authentik-server:
    ports:
      - "9000:9000"
    image: ghcr.io/goauthentik/server:2025.12.3
    environment:
      - AUTHENTIK_SECRET_KEY=please-change-me
      - AUTHENTIK_POSTGRESQL__HOST=authentik-db
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=authentik
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_REDIS__DB=1
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false

      - AUTHENTIK_BOOTSTRAP_EMAIL=admin@local
      - AUTHENTIK_BOOTSTRAP_PASSWORD=admin
      - AUTHENTIK_BOOTSTRAP_TOKEN=please-change-me-bootstrap-token
    command: [ "server" ]
    volumes:
      - ./authentik/media:/media
      - ./authentik/custom-templates:/templates
    labels:
      - traefik.enable=true
      - traefik.http.routers.authentik.rule=Host(`auth.localhost`)
      - traefik.http.routers.authentik.entrypoints=web
      - traefik.http.services.authentik.loadbalancer.server.port=9000
    networks:
      - internal
    depends_on:
      - authentik-db
      - authentik-redis

  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.12.3
    environment:
      - AUTHENTIK_SECRET_KEY=please-change-me
      - AUTHENTIK_POSTGRESQL__HOST=authentik-db
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=authentik
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_REDIS__DB=1
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false

      - AUTHENTIK_BOOTSTRAP_EMAIL=admin@local
      - AUTHENTIK_BOOTSTRAP_PASSWORD=admin
      - AUTHENTIK_BOOTSTRAP_TOKEN=please-change-me-bootstrap-token
    command: [ "worker" ]
    volumes:
      - ./authentik/media:/media
      - ./authentik/custom-templates:/templates
    networks:
      - internal
    depends_on:
      - authentik-db
      - authentik-redis

  authentik-proxy:
    image: ghcr.io/goauthentik/proxy:2025.12.3
    environment:
      # ВАЖНО: это публичный URL authentik (через Traefik), чтобы редиректы работали
      - AUTHENTIK_HOST=http://auth.localhost
      # Так как у тебя HTTP (без TLS) — включаем insecure
      - AUTHENTIK_INSECURE=true
      # Токен вставишь после настройки Outpost в UI authentik
      - AUTHENTIK_TOKEN=HnzzGdowmWPtsFtPKZTuNnrsZFLMlZLi97LN29z9BsQQmKLFe6kflYg7vI3x
    networks:
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.services.authentik-proxy.loadbalancer.server.port=9000

      # py.localhost -> outpost path
      - traefik.http.routers.py-outpost.rule=Host(`py.localhost`) && PathPrefix(`/outpost.goauthentik.io/`)
      - traefik.http.routers.py-outpost.entrypoints=web
      - traefik.http.routers.py-outpost.priority=100
      - traefik.http.routers.py-outpost.service=authentik-proxy

      # js.localhost -> outpost path
      - traefik.http.routers.js-outpost.rule=Host(`js.localhost`) && PathPrefix(`/outpost.goauthentik.io/`)
      - traefik.http.routers.js-outpost.entrypoints=web
      - traefik.http.routers.js-outpost.priority=100
      - traefik.http.routers.js-outpost.service=authentik-proxy

      # grafana.localhost -> outpost path
      - traefik.http.routers.grafana-outpost.rule=Host(`grafana.localhost`) && PathPrefix(`/outpost.goauthentik.io/`)
      - traefik.http.routers.grafana-outpost.entrypoints=web
      - traefik.http.routers.grafana-outpost.priority=100
      - traefik.http.routers.grafana-outpost.service=authentik-proxy
    depends_on:
      - authentik-server

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER=app
      - RABBITMQ_DEFAULT_PASS=app
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - internal
    # UI удобно в деве открыть через Traefik (опционально)
    labels:
      - traefik.enable=true
      - traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.localhost`)
      - traefik.http.routers.rabbitmq.entrypoints=web
      - traefik.http.services.rabbitmq.loadbalancer.server.port=15672